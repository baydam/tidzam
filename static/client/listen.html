<center>
  <table id="listen_list"><tbody></tbody></table>
</center>
<audio controls id="audio_player">
  <source src="" type="audio/wav">
</audio>

<script>
const livestream_io = io("//tidzam.media.mit.edu/",{ path: '/livestream/socket.io'});

function unload_audio(){
  try{
  client_id = $("#audio_player").attr("src").split("/");
  client_id = client_id[client_id.length-1]
  client_id = client_id.split("-")[1]
  livestream_io.emit('sys', {sys:{unloadsource:{name:"client-"+client_id} } });
  }
  catch(err){
    console.log("No audio stream loaded.")
  }
}


livestream_io.on('sys', function(msg){
  //console.log("HERE " + JSON.stringify(msg))
  if (!msg.sys)
  return
  if(msg.sys.database){
    var eventDates = {}
    for (var database in msg.sys.database){
      eventDates[database] = {};
      for (var i=0;i < msg.sys.database[database]["database"].length; i++){
        f = msg.sys.database[database]["database"][i]
        start = f[0].split("-");
        start_date = new Date(start[0],start[1]-1,start[2])
        end   = f[1].split("-");
        end_date = new Date(end[0],end[1]-1,end[2])
        for (var d = start_date; d <= end_date; d.setDate(d.getDate() + 1))
          eventDates[database][d] = new Date(d).toString();
        }
      }

    // Generate the HTML content for the list of available streams
    $("#listen_list").html('<tr><td>Database</td><td>Date</td><td>Time</td><td>Channel</td><td></td></tr>');

    for (var database in msg.sys.database){
      template = '<tr><td class="listen_database">'+database+'</td><td class="listen_dateselector"><input type="button" class="dateselector" id="dateselector_'+database+'"></td>'+
                '<td><div class="timeselector listen_timeselector" id="timeselector_'+database+'"><span class="time_label" id="time_label_'+database+'"></span></div></td>';
      template += '<td style="width:50px;"><select id="channels_'+database+'">';
      for(var i=0; i < msg.sys.database[database]["nb_channels"]; i++)
        template += '<option>'+i+'</option>'
      template += '<option>all</option><option>copy</option></select></td><td style="width:50px;"><input type="image" src="img/play.png" class="source_btn" id="source_btn_'+database+'"></td>' +
                '</tr>';

      $("#listen_list tbody").append(template);

      $( "#dateselector_"+database ).datepicker({
          beforeShowDay: function(date) {
            database = this.id.split("_");
            database = database[database.length-1];
            if (eventDates[database][date]) return [true, "event", eventDates[database][date]];
            else                  return [true, '', ''];
            }
          });

      $( "#timeselector_"+database ).slider({range: false,
        max: 24 * 60 * 60,
        slide: function(event, ui) {
          database = this.id.split("_");
          database = database[database.length-1];
          var hours   = Math.floor(ui.value / 3600);
          var minutes = Math.floor((ui.value - (hours * 3600)) / 60);
          var seconds = ui.value - (hours * 3600) - (minutes * 60);
          $( "#time_label_"+database ).text(hours+":"+minutes+":"+seconds)
        }
      });

      $( "#source_btn_"+database ).on("click", function(){
        unload_audio();
        if ($("#source_btn_"+database).attr("src") == "img/stop.png"){
          $("#source_btn_"+database).attr("src","img/play.png")
          return
        }

        database = this.id.split("_");
        database = database[database.length-1];
        var date      = $( "#dateselector_"+database ).val().split('/');
        var time      = $( "#time_label_"+database ).html().replace(/:/g,"-");
        var channels   = $( "#channels_"+database ).val();
        format = "ogg";
        if (channels == "all") channels = null;
        else if (channels == "copy") {
          format  = "copy";
          channels = null;
        }
          req = {
            sys:{
              loadsource:{
                name:"client-"+(new Date().getTime()).toString().slice(-10),
                url:null,
                database:database,
                channels:channels,
                format:format,
                date:date[2]+"-"+date[0]+"-"+date[1]+"-"+time
            }
          }
        }
        console.log(req)
        $("#source_btn_"+database).attr("src","img/stop.png")
        livestream_io.emit('sys', req);

        // Load the audio player
        function load_audio(){
          setTimeout(function(){
            try{
              console.log("http://tidzam.media.mit.edu/audio/"+req.sys.loadsource.name+"-out_0.ogg")
              $( '#audio_player'  ).attr('src', "http://tidzam.media.mit.edu/audio/"+req.sys.loadsource.name+"-out_"+channels+".ogg");
              $( '#audio_player'  ).load();
              $( '#audio_player' ).trigger('play');
            }
            catch(err){
              load_audio();
            }
          },3000);
        }
        load_audio();

        });
    }
  }
});
setTimeout(function(){livestream_io.emit('sys', {"sys":{"database":""}})},1000);
</script>
