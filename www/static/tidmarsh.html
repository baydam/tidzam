<style>
#map{
}

#stats_area{
  height:40%;
}

#stats_iframe{
  width:100%;
  height:500px;
  border-width:0px;
}

#statistic_selector{
  margin-left:50px;
  font-size:20px;
  color:black;
  text-decoration:none;
  float:left;
}
#statistic_selector:hover{
  text-decoration:underline;
}

#map{
  width:100%;
  height:500px;
}

</style>
<audio id="audio_player">
  <source src="" type="audio/wav">
</audio>

<div class="modal fade" id="stats_loading_div">
  <div class="modal-dialog  modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header  text-white bg-success">
        <h5 class="modal-title">Loading</h5>
      </div>
      <div class="modal-body text-black">
        <p id="stats_loading_text"></p>
        <div class="progress">
          <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" id="stats_loading_progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%">0%</div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="container">
  <h2 class="my-4 text-center">
    Tidmarsh Farms
  </h2>
  <div >
    <div class="w-50" style="float:left;">
      <img src="static/img/photo/tidmarsh.jpg" class="img-fluid border rounded" style="object-fit:contain; max-width:80%;">
    </div>
      <p class="text-justify">
      Tidmarsh Farms, a 600 acre-farm situated in Manomet Village, Plymouth Massachusetts,
      is home to the largest freshwater restoration in Massachusetts.
      </p>
      <p class="text-justify">
      In the 1980’s these farms were purchased by Evan Schulman and in 1989,
      the farms produced 1% of Ocean Sprays harvest.
      </p>
      <p class="text-justify">
      In the early 2000’s, Evan, Glorianna and the Schulman children made the decision
       to cease farming and to transition these farms for the future.  As part of that transition,
       the recently restored Tidmarsh East was recently purchased by Mass Audubon and is now home
       to Mass Audubon’s Tidmarsh Wildlife Sanctuary.  In parallel Tidmarsh West was purchased
       by the Town of Plymouth as an open space preserve.  It will undergo an ecological restoration in 2019/2020.
      </p>
  </div>

  <div class="card my-1 p-1 border rounded">
    <div class="card-header bg-success text-white">
      <h4>Tidzam</h4>
    </div>
    <div class="card-body border rounded my-1 p-2">
      <h5 class="card-title">How To use ?</h5>
      <p class="card-text text-justify">
          This module allows you to visualize the statistics of Tidzam detections over the year.
          You can select different periods of time as well as a particular classes by clicking on it
          (on the bars or on the legend). This will provide you more details about the classe such as for example the bird species
          and show also the relative density of detections between the different microphones on the map.
      </p>
      <p class="card-text text-justify">
          This map module allows you to visualize online the current Tidzam detections on the different microphones.
          You can listen directly the microphone streams by clicking on the map markers which will also print the
          real-time plot chart of the classifier outputs for the selected microphone.
      </p>
    </div>
    <nav class="navbar navbar-light navbar-expand-lg border rounded my-1 p-2">
        <a href="#" id="statistic_selector" class="navbar-text d-flex justify-content-start" onclick="statistic_previous();">tidzam > </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-date" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="navbar-collapse collapse justify-content-end" id="navbar-date" style="width:310px;">
            <input type="button" class="btn navbar-btn btn-secondary mx-1" style="width:120px;" id="stats_download"   value="Download">
            <input type="button" class="btn navbar-btn btn-secondary mx-1" style="width:80px;" id="stats_day"   value="Day">
            <input type="button" class="btn navbar-btn btn-secondary mx-1" style="width:80px;" id="stats_month" value="Month">
            <input type="button" class="btn navbar-btn btn-secondary ml-1" style="width:80px;" id="stats_year"  value="Year">
        </div>
      <style id="hide"></style>
    </nav>
    <div id="stats_area" class="my-1 z-depth-1"></div>
    <div id="map" class="z-depth-1  border rounded"></div>
    <div class="d-flex d-flex-row justify-content-between border rounded my-1 p-2">
      <span id="audio_text">No audio live channel</span>
      <div id="time_text"></div>
    </div>
    <iframe id="stats_iframe" src="https://www.wikipedia.org/" class="border rounded"></iframe>
  </div>
</div>
<script>

me = {}
chain = new ChainAPI();
var markers = Array();
var map = new google.maps.Map(document.getElementById("map"), {
    center: {lat: 41.901, lng: -70.571101},
    zoom: 16,
    mapTypeId: google.maps.MapTypeId.SATELLITE
  });

  /*************************************/
  /*     TIDMARSH MAP                  */
  /*************************************/


/* ===========================================================================

  STATISTIC VIZUALIZATION
  * Request the statistic from chain API
  * Print stastitic bar chart with navigation module
  * Show on the map the density of detections with circles around the markers

   =========================================================================== */
$( "#stats_download").click(function(){
  $("<a />", {
    "download": "data.json",
    "href" : "data:application/json," + encodeURIComponent( JSON.stringify(chain) )
  }).appendTo("body")
  .click(function() {
     $(this).remove()
  })[0].click()
});

$( "#stats_day" ).datepicker({
    dateFormat: 'yy-mm-dd',
    onClose: function(){
      $("#stats_month").val("Month");
      $("#stats_year").val("Year");
    }
  });

$( "#stats_day" ).change(function(val){
    val = $( "#stats_day" ).val().split("-")
    load_statistics({"year":val[0],"month":val[1],"day":val[2]},"");
  })

$('#stats_month').datepicker( {
    changeMonth: true,
    changeYear: true,
    showButtonPanel: true,
    dateFormat: 'yy-mm',
    beforeShow: function() { $('#hide').html('.ui-datepicker-calendar{display:none;}'); },
    onClose: function(dateText, inst) {
      $(this).datepicker('setDate', new Date(inst.selectedYear, inst.selectedMonth, 1));
      setTimeout(function(){$('#hide').html('');},300);
      $("#stats_day").val("Day");
      $("#stats_year").val("Year");
      val = $( "#stats_month" ).val().split("-");
      load_statistics({"year":val[0],"month":val[1]},"");
    }
  });

$('#stats_year').datepicker( {
    changeYear: true,
    showButtonPanel: true,
    dateFormat: 'yy',
    beforeShow: function() {
      $('#hide').html('.ui-datepicker-calendar{display:none;}');
    },
    onClose: function(dateText, inst) {
      $(this).datepicker('setDate', new Date(inst.selectedYear, 1, 1));
      setTimeout(function(){ $('#hide').html(''); },300);
      $("#stats_day").val("Day");
      $("#stats_month").val("Month");

      val = $( "#stats_year" ).val().split("-");
      load_statistics({"year":val[0]},"");
    }
  });

this.data_view = {}
colors = ["blue", "red", "orange", "green", "purple", "yellow", "brown", "black", "gray"]
function show_statistics(target, subclasse, callback){
  var ready = false;
  var database = {}
  var options = {
    title:'Sensors detections distribution',
    width: $(window).parent().width(),
    height: $(window).parent().height()*0.4,
    legend: { position: 'top', maxLines: 2 },
    bar: { groupWidth: '75%' },
    isStacked: false,
    colors:colors,
    vAxis: {}
  };

  me.statistic_conf = target
  me.col_name       = subclasse

 if (subclasse == "birds")
	options.vAxis.scaleType = 'log';

  try{
    // Build a dictionnary
    for (var dev=0; dev < chain.list_devices.length; dev++){
      for (var sensor=0; sensor < chain.list_devices[dev].list_sensors.length; sensor++){

        if (subclasse == ""){
          // If it is a primary classe
          if (chain.list_devices[dev].list_sensors[sensor].title.indexOf("-") == -1)
            sens = chain.list_devices[dev].list_sensors[sensor].title;
          // Get primary classe name
          else sens = chain.list_devices[dev].list_sensors[sensor].title.split("-")[0]
        }
        // If this sensor is not a subclasse, go to the next
        else if (chain.list_devices[dev].list_sensors[sensor].title.indexOf(subclasse) == -1)
          continue
        else sens = chain.list_devices[dev].list_sensors[sensor].title;

        chain.list_devices[dev].list_sensors[sensor].count = 0;
        for (var d=0; d < chain.list_devices[dev].list_sensors[sensor].data.length; d++){
          chain.list_devices[dev].list_sensors[sensor].count = Math.max(chain.list_devices[dev].list_sensors[sensor].count, chain.list_devices[dev].list_sensors[sensor].data[d].count)

          if(!target.year)
          column = (new Date(chain.list_devices[dev].list_sensors[sensor].data[d].timestamp)).getYear();
          else if(!target.month)
          column = (new Date(chain.list_devices[dev].list_sensors[sensor].data[d].timestamp)).getMonth();
          else if(!target.day)
          column = (new Date(chain.list_devices[dev].list_sensors[sensor].data[d].timestamp)).getDate();
          else
          column = (new Date(chain.list_devices[dev].list_sensors[sensor].data[d].timestamp)).getHours();

          if ("undefined" === typeof database[column])          database[column] = {}
          if ("undefined" === typeof database[column][sens])    database[column][sens] = 0
          else database[column][sens] = chain.list_devices[dev].list_sensors[sensor].data[d].count;
        }
      }
    }
    ready = true;
    $("#stats_loading_text").text("");
    $("#classe_picture").attr("src","static/img/" + (subclasse != "" ? subclasse : "tidzam") + ".png");
  }
  catch(err){
    console.log("Data loading...")
  }
  // Conert to database format
  var monthNames = ["January", "February", "March", "April", "May", "June",
  "July", "August", "September", "October", "November", "December"
  ];

  // Build the sensor dictionnary
  dict = []
  for (var column in database)
  for (var sensor in database[column]){
    found = false;
    for (var d in dict)
    if (dict[d] == sensor)
    found = true
    if (!found) dict.push(sensor)
  }

  data_formatted = []
  header = ["Month"]
  header = header.concat(dict)
  i = 0;
  for (var column in database){
    // Column label
    if("undefined" != typeof target.day) {
      if (column == 0)       data_formatted.push(["12 am"])
      else if (column <= 11)  data_formatted.push([column+" am"])
      else if (column == 12) data_formatted.push(["12 pm"])
      else                   data_formatted.push([column%12+" pm"])
    }
    else if("undefined" != typeof target.month)    data_formatted.push([monthNames[parseInt(target.month)-1]+" "+column])
    else if("undefined" != typeof target.year)     data_formatted.push([monthNames[column]])
    else                                           data_formatted.push([column])


    for (var d in dict){
      if ( database[column][dict[d]] )
      data_formatted[i].push(database[column][dict[d]])
      else data_formatted[i].push(0);
    }
    i++;
  }
  data_formatted.unshift(header);
  data_array = google.visualization.arrayToDataTable(data_formatted);
  this.data_view = new google.visualization.DataView(data_array);
  chart.draw(this.data_view, options);

  if (!ready)
  setTimeout(function(){
    show_statistics(target, subclasse, callback);
  },2000);
  else if(callback)
  callback("done");
}

var circles = []

$(window).resize(function() {
    if(this.resizeTO) clearTimeout(this.resizeTO);
    this.resizeTO = setTimeout(function() {
        $(this).trigger('resizeEnd');
    }, 500);
  });



function draw_chart(sensor_to_show, color){
  last_sensor = sensor_to_show
  last_color  = color;
  // Compute max value for normalization
  max_count = 0;
  max_count_sensor = 0;
  for (var dev=0; dev < chain.list_devices.length; dev++)
    for (var sensor=0; sensor < chain.list_devices[dev].list_sensors.length; sensor++){
      max_count = Math.max(max_count, chain.list_devices[dev].list_sensors[sensor].count)
      if (sensor_title = chain.list_devices[dev].list_sensors[sensor].title == sensor_to_show)
      max_count_sensor = Math.max(max_count_sensor, chain.list_devices[dev].list_sensors[sensor].count)
    }

  for (var dev=0; dev < chain.list_devices.length; dev++){
    dev_title = chain.list_devices[dev].title;
    // Looking for device location
    for (var m in markers)
      if (markers[m].name == dev_title)
        break;

    for (var sensor=0; sensor < chain.list_devices[dev].list_sensors.length; sensor++){
        sensor_title = chain.list_devices[dev].list_sensors[sensor].title;

      // Looking for sensor circle of the device
      found = false
      for (var c in circles){
        //console.log(c + " " + circles[c].dev + " " + dev + " " + circles[c].sensor + " " + sensor)
        if (circles[c].dev == dev && circles[c].sensor == sensor){
          found = true;
          circle = circles[c];
          break;
        }
      }
      if (!found){
        var circle = new google.maps.Circle();
        circle.dev = dev;
        circle.sensor = sensor;
        circles.push(circle);
      }

      circle.setOptions({
        strokeColor: color,
        strokeOpacity: Math.max(chain.list_devices[dev].list_sensors[sensor].count/max_count,0.2),
        strokeWeight: 2,
        fillColor: color,
        fillOpacity: Math.max(chain.list_devices[dev].list_sensors[sensor].count/max_count,0.2),
        center: markers[m].position,
        radius: (chain.list_devices[dev].list_sensors[sensor].count/max_count_sensor)*30
      });
      // If this circle is of our sensor, show it else hide it
      if (sensor_title == sensor_to_show)   circle.setMap(map);
      else                                  circle.setMap(null);

    }
  }
}

function load_statistics(conf, subclasse){
  me.statistic_conf = conf;
  $("#stats_loading_div").modal('show');
  chain.getData(conf,function(data){
    $("#stats_loading_text").text(data.text);
    $('#stats_loading_progressbar').attr('aria-valuenow', data.progress).css('width',data.progress+"%").html(data.progress+"%");
  });
  setTimeout(function(){
    show_statistics(conf, subclasse, function(msg){
      $("#stats_loading_div").modal('hide');
      for(var i=0; i < this.data_view.getNumberOfColumns(); i++)
        if (this.data_view.getColumnLabel(i) == "birds")
          break;
      draw_chart("birds", colors[i-1]);
    });
  },1000);
}

// Load the data
var chart = new google.visualization.ColumnChart(document.getElementById("stats_area"));

function statistic_previous(){
    var text  =   $("#statistic_selector").text()
    text      = text.split(" > ")
    text.shift()
    if (text.length > 0)   text.pop()
    $("#statistic_selector").text("tidzam > " + text.join(" > "))

    text = text.join("-")
    show_statistics(me.statistic_conf, text, function(msg){
      $("#stats_loading_div").modal("hide");
      draw_chart("", colors[i-1]);
    });
  };

// Listener to draw on the map detection density
google.visualization.events.addListener(chart, 'select', function () {
  var sel = chart.getSelection();
  if (sel.length > 0) {
      var col_name = this.data_view.getColumnLabel(sel[0].column);
      me.col_name = col_name
      for(var i=0; i < this.data_view.getNumberOfColumns(); i++)
        if (this.data_view.getColumnLabel(i) == col_name)
          break;

      show_statistics(me.statistic_conf, me.col_name, function(msg){
        $("#stats_loading_div").modal("hide");
        draw_chart(col_name, colors[i-1]);
      });

      $("#statistic_selector").text("tidzam > " + col_name.replace("-", " > "))
      col_name = col_name.split("-")
      $("#stats_iframe").attr('src', "https://en.wikipedia.org/wiki/"+col_name[col_name.length-1])
  }
});

//redraw graph when window resize is completed
$(window).on('resizeEnd', function() {
try{
  show_statistics(me.statistic_conf, me.col_name,function(msg){});
  console.log("redraw");

}
catch(err){
  console.log("ERROR redraw statistic graph");
  //TODO : Catch incompatibility with statistic
}
});

/* ===========================================================================

  MAP Live Detection
  * Print on the map the current detections on the microphone markers
  * Draw the Graph chart of classifier outputs when its marker is clicked

   =========================================================================== */

   var infowindow = new google.maps.InfoWindow();
   this.streams  = chain.getStreamsInfo();
   for (var i=0; i<this.streams.length; i++){
     try {
       marker = new google.maps.Marker({
         position: {lat: this.streams[i].geoLocation.latitude, lng: this.streams[i].geoLocation.longitude},
         icon:{
           url: "static/img/unknown.png",
           scaledSize: new google.maps.Size(50, 31)
         }
       });
       marker.name = this.streams[i].name
       marker.setMap(map);
       markers.push(marker);
     }
     catch(err){
       console.log("Unable to load marker for " + this.streams[i].name)
     }
   }

function DetectionMap(divID){
  CHANNEL_GLOBAL = null
  GRAPH_GLOBAL   = {name:null}

  const livestream_io = io("//tidzam.media.mit.edu/",
        { path: '/livestream/socket.io'});

  const socket = io("//tidzam.media.mit.edu/",
      { path: '/socket.io' ,
       forceNew:true});

  /*************************************/
  /*            MAP CREATION           */
  /*************************************/
  var location = {lat: 41.901, lng: -70.571101};
  var markers = Array()

    /*************************************/
    /*     TIDZAM OUTPUT VISUALIZATION   */
    /*************************************/
    this.streams  = chain.getStreamsInfo();

    for (var i=0; i<this.streams.length; i++){
      try {
        marker = new google.maps.Marker({
          position: {lat: this.streams[i].geoLocation.latitude, lng: this.streams[i].geoLocation.longitude},
          icon:{
            url: "static/img/unknown.png",
            scaledSize: new google.maps.Size(10)
          }
        })
        marker.name = this.streams[i].name
        marker.setMap(map);
        markers.push(marker);

        var infowindow = new google.maps.InfoWindow();
        google.maps.event.addListener(marker, 'click', function() {
          CHANNEL_GLOBAL = this.name
          stream = '//tidzam.media.mit.edu/icecast/'+this.name.replace(":","-")+'.ogg'
          $( '#audio_player'  ).attr('src', stream);
          $( '#audio_player' ).trigger('play');
          $( "#audio_text" ).html("Playing " + this.name);
          GRAPH_GLOBAL   = {name:null}

          // Generate the chart div depending of the viewport
          if (window.matchMedia( "(min-width: 992px)" ).matches)  {
            content = '<div id="graph" style="padding:1px"></div>'
            content += "<center>(" + this.getPosition().lat() + ", " + this.getPosition().lng() + ')</center>';
            infowindow.open(map, this);
            infowindow.setContent(content)
          }

          // FULLSCREEN for Small Devices
          else {
            content = '<div id="graph" class="fixed-top container-full"></div>'
            content += "<center>(" + this.getPosition().lat() + ", " + this.getPosition().lng() + ')</center>';
            $("#main").append(content); // F
          }
          $("#graph").click(function(){
            $("#graph").remove("");
            });
        });
      }
      catch(err){
        console.log("Unable to load marker for " + this.streams[i].name)
      }
    }

    function drawChart(){
      GRAPH_GLOBAL = new Chart("graph", CHANNEL_GLOBAL, null)
      socket.emit('sys',  {sys:{classifier: {list:''}}} );
    }
    //create trigger to resizeEnd event
    $(window).resize(function() {
        if(this.resizeTO) clearTimeout(this.resizeTO);
        this.resizeTO = setTimeout(function() {
            $(this).trigger('resizeEnd');
        }, 500);
      });

    //redraw graph when window resize is completed
    $(window).on('resizeEnd', function() {
        try{
          drawChart();
        }
        catch(err){
          //TODO : Catch incompatibility with statistic
        }
      });

  socket.on('sys', function(msg){
    for (var i=0; i < msg.length; i ++){
      if (i == 0) $( "#time_text" ).html(msg[i].analysis.time.replace("T", " "));

      // Update all Marker icons
      for(var j=0; j < markers.length; j++)
        if (markers[j].name == msg[i].chan){
          markers[j].setIcon({
            url: "static/img/"+ msg[i].analysis.result[msg[i].analysis.result.length-1] +".png" ,
            scaledSize: new google.maps.Size(50, 31)
          });
        }

      // Update graph of the selected one
      if (CHANNEL_GLOBAL == msg[i].chan){
        if (GRAPH_GLOBAL.name != CHANNEL_GLOBAL){
          drawChart();
        }
        GRAPH_GLOBAL.updateHistory(msg[i].analysis)
      }
    }
    // Update the list of classifier when received
    if (msg.sys)
    if (msg.sys.classifier)
    if (msg.sys.classifier.list)
    GRAPH_GLOBAL.classifier_list = msg.sys.classifier.list;
  });
}

today = new Date();


$( document ).ready(function() {
    load_statistics({"year":today.getFullYear(),"month":today.getMonth()+1,"day":today.getDate()}, "");
    DetectionMap("map");
    });


</script>
