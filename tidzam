#!/bin/bash

export LD_LIBRARY_PATH=/opt/cuda/lib64/
set +e

PATH_TIDZAM=/opt/tidzam/

# Hack because python ...
CURRENT_PATH=`pwd`
cd $PATH_TIDZAM

LOGS=$PATH_TIDZAM/logs/
DATABASE=/opt/tidzam/out-tidzam/
BACKUP=$PATH_TIDZAM/database.tar.gz
BACKUP_REMOTE=slash6475@duhart-clement.fr:~/

PID_FILE=/tmp/tidzam-pid
RAM_LIMIT=50
PID=`cat $PID_FILE`
DEBUG=1
JACK_NAME=tidzam

ACTION=$1

export CUDA_VISIBLE_DEVICES=1

install_cuda(){
  echo "CUDA Installation"
  wget https://developer.nvidia.com/compute/cuda/9.0/Prod/local_installers/cuda-repo-ubuntu1704-9-0-local_9.0.176-1_amd64-deb
  dpkg -i cuda-repo-ubuntu1704-9-0-local_9.0.176-1_amd64.deb
  apt-key add /var/cuda-repo-<version>/7fa2af80.pub
  apt-get update
  apt-get install cuda
  echo "Please download and install cudaCNN v0.6 Runtime library:"
  echo "https://developer.nvidia.com/rdp/cudnn-download"
  read -p "Is it done ? [y/N]" yn
  case $yn in
    [Yy]* ) ;;
    * ) exit;;
  esac
  apt-get install libcupti-dev
  pip3 install tensorflow-gpu
}

install(){
  echo "TidZam Installation"
  echo -n "==================="

  echo "System Package Installation"
  echo "==========================="
  apt-get install python3-pip python3-dev redis-server jackd2 icecast2 mpv ffmpeg unzip ices2

  read -p "Do you want to install CUDA ? [y/N]" yn
  case $yn in
    [Yy]* ) install_cuda;;
    * ) pip3 install tensorflow ;;
  esac

  echo "Python Package Installation"
  echo "==========================="
  pip3 install aiohttp aiohttp-cors aioredis asyncio hiredis httplib2 JACK-Client matplotlib numpy python-engineio chainclient python-socketio redis requests scipy socketIO-client sounddevice SoundFile websocket-client

  echo "TidZam Download"
  echo "==============="
  wget https://github.com/mitmedialab/tidzam/archive/master.zip
  unzip tidzam-master
  mv tidzam-master/* .
  rmdir tidzam-master

  echo "TidZam Configuration"
  echo "===================="
  mv icecast/icecast.xml /etc/icecast2
  

  echo "Installation terminated."
}

test_memory (){
   PID=$1
   MEM=`ps -emo %mem,pid | grep $PID`
   MEM=`echo $MEM | cut -d' ' -f1`

   if [[ `echo $MEM'>'$RAM_LIMIT | bc -l` == 1 ]]; then
      return 1
   fi
   return 0
   }

if [ "$ACTION" == "start" ]; then
  if [ -f $PID_FILE ]; then
    echo "TidZam is already running"
  else
    echo "Booting..."
    echo -n "        Jack server       "
    nohup /usr/bin/jackd  \
        --port-max 2048 \
        -v \
        -r \
        -t5000000000 \
        -ddummy \
        -r48000 \
        -p8192  \
        > $LOGS/tidzam-jack.log.txt 2>&1  &
    #nohup /usr/bin/jackd -r -d alsa -r 44100 &
    echo $! > "$PID_FILE-jack"
    echo "[ok]"
    sleep 1

    echo -n "        Database Manager  "
    nohup python3 -u -W ignore src/TidzamDatabaseManager.py \
        --database-folder=out-tidzam/  \
        > $LOGS/tidzam-database-manager.log.txt 2>&1 &
    echo $! > "$PID_FILE-database_manager"
    echo "[ok]"
    sleep 1

    echo -n "        Stream Loader     "
    nohup python3 -u -W ignore $PATH_TIDZAM/src/TidzamStreamManager.py \
        --debug=$DEBUG \
        --sources=tidzam.conf \
        > $LOGS/tidzam-stream-manager.log.txt 2>&1  &
    echo $! > "$PID_FILE-stream_loader"
    echo "[ok]"
    sleep 1

    echo -n "        Analyzer Engine   "
    nohup python3 -u -W ignore $PATH_TIDZAM/src/TidzamAnalyzer.py \
          --nn=classifiers/  \
          --overlap=0.25 \
          --debug=$DEBUG \
          --jack=tidzam-,impoundment,herring \
          --port=8001 \
          --out=$DATABASE \
          --chainAPI=slash:toto@chain-api.media.mit.edu/sites/18 \
          > $LOGS/tidzam-analyzer.log.txt 2>&1 &

    echo $! > $PID_FILE
    echo "[ok]"
    echo "TidZam [  READY  ]"
  fi

elif [ "$ACTION" == "stop" ]; then
  echo "Stopping..."
  echo -n "        Analyzer Engine       "
  kill -9 `cat $PID_FILE`
  rm $PID_FILE
  echo "[ok]"
  echo -n "        Stream Loader         "
  kill -9 `cat $PID_FILE-stream_loader`
  rm "$PID_FILE-stream_loader"
  echo "[ok]"
  echo -n "        Jack server           "
  kill -9 `cat $PID_FILE-jack`
  rm "$PID_FILE-jack"
  echo "[ok]"
  echo -n "        Database Manager      "
  kill -9 `cat $PID_FILE-database_manager`
  rm "$PID_FILE-database_manager"
  echo "[ok]"
  echo -n "        Cleaning ffmpeg / mpv "
  pkill mpv
  pkill ffmpeg
  echo "[ok]"
  echo "TidZam [  STOP  ]"

elif [ "$ACTION" == "restart" ]; then
  $0 stop
  sleep 3
  $0 start

elif [ "$ACTION" == "install" ]; then
  install

# Check RAM usage, if exceed the limit than restart (in case of memory leak)
elif [ "$ACTION" == "check" ]; then
  test_memory $PID
  if [[ $? == 1 ]]; then
    $0 restart
  fi

elif [ "$ACTION" == "backup" ]; then
  echo "TidZam backup $DATABASE -> $BACKUP"
  mv $BACKUP $BACKUP-0
  tar -zcvf $BACKUP $DATABASE
  echo  "Backup to remote $BACKUP_REMOTE"
  scp $BACKUP $BACKUP_REMOTE
  echo "Backup terminated"

elif [ "$ACTION" == "database-process" ]; then
  echo "TidZam process database"
  python3 tidstream_split.py
  echo "terminated"

else
  echo "tidzam (start | stop | check | restart | install | backup | database-process)"
fi

#cd $CURRENT_PATH
